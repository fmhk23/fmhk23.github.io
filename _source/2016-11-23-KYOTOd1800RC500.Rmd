---
title: "京都ダート1800m(500万下) 2004-2016"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
permalink: KYOTOd1800RC500.html
tags: [news, getting_started]
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## 目的(Objective)

従来方法によるコース紹介では、脚質を主観的に分類した後に1着率、3着内率、回収率を示すのが精一杯であり、馬券構築の際の参考にはなるが決め手にはならない。  
本レポートでは、機械学習により馬の脚質を分類した後、決着のパターンを集計し考察する。  
これにより、例えば以下の様なことが明らかになる。  

- 逃げ馬だけで3位以内を独占するパターンはどの程度あるのか？
- その時のオッズはどの程度か？
- 馬場状態による影響はあるか？

## コースの特徴(一般論)

- ダートコースの常識通り、先行馬有利。
- 1コーナーまで286m、軽いダート、4つのコーナー。
- タイムが出やすい。

```{r, echo=FALSE, error=FALSE, warning=FALSE}
options(digits = 2)
suppressMessages(library(data.table))
suppressMessages(library(dplyr))
suppressMessages(library(stringr))

race.df <- fread("../_mydata/KYOTOD1800_PassClustered.csv") %>% as.data.frame() %>% 
  dplyr::filter(Date > 2004)

race.df$RaceKey <- str_c(race.df$Date, "_",race.df$Open, "_",race.df$Days, "_",race.df$R)
```

## 馬の脚質分類

分析を行うに当たり、まず機械学習(K-means法)により、逃げ馬と差し馬の分類を行った。  
特徴量として、前走~4走前までの第1コーナー通過順位と、最終コーナー通過順位の合計8つの項目を用いた。  
以後、逃げ馬を0、差し馬を1で表す。  

なお、K-means法の特性上、逃げ馬と差し馬の数は同程度に分類される。  
そのため、あくまで「どちらかといえば」の判断になる。  
一般的な分類（逃げ、先行、差し、追い込み、マクリ）などとは言葉の意味が異なってくることを頭に入れておいて欲しい。  
また過去の傾向のみを基準に分類しているため急に騎手が作戦を代えてきたケースについては考慮していない。  
例えば今まで後ろからだった馬が当該レースでは逃げた場合には、差し馬として分類されている。  
どちらにせよ馬券を買う前にはわからないことなので問題ないだろう。

## 脚質

どのような脚質の馬がどの程度着内に入っているかを集計する。  

```{r, echo=FALSE, error=FALSE, warning=FALSE, fig.width= 6.00, fig.height= 4.00}
RunType1st_df <- race.df %>% dplyr::filter(Result == 1) %>%
  dplyr::select(RaceKey, `馬場` = FieldCond, RunType1 = predictPassing, Odds1 = Odds)
RunType2nd_df <- race.df %>% dplyr::filter(Result == 2) %>%
  dplyr::select(RaceKey, RunType2 = predictPassing, Odds2 = Odds)
RunType3rd_df <- race.df %>% dplyr::filter(Result == 3) %>%
  dplyr::select(RaceKey, RunType3 = predictPassing, Odds3 = Odds)
RunType0_df <- race.df %>% dplyr::filter(predictPassing == 0) %>% 
  group_by(RaceKey) %>% 
  summarise(N0 = length(predictPassing))
RunType1_df <- race.df %>% dplyr::filter(predictPassing == 1) %>% 
  group_by(RaceKey) %>% 
  summarise(N1 = length(predictPassing))

suppressMessages(
  RunSummary <- dplyr::left_join(RunType1st_df, RunType2nd_df, by = "RaceKey") %>% 
  dplyr::left_join(RunType3rd_df, by = "RaceKey") %>% 
  dplyr::left_join(RunType0_df, by = "RaceKey") %>% 
  dplyr::left_join(RunType1_df, by = "RaceKey") %>% 
  dplyr::arrange(RaceKey)
)

RunSummary$RaceType <- str_c(RunSummary$RunType1, RunSummary$RunType2, RunSummary$RunType3)
RunSummary$jds <- ifelse(RunSummary$Odds1 > RunSummary$Odds2, 1, 0)

RunSummaryAll <- RunSummary %>% dplyr::group_by(RaceType) %>%
  summarise(`数` = length(RaceType),
            `占有率` = 100 * `数` / nrow(RunSummary),
            `逃げ` = mean(N0, na.rm = TRUE),
            `差し` = mean(N1, na.rm = TRUE),
            `1着オッズ` = median(Odds1, na.rm = TRUE),
            `2着オッズ` = median(Odds2, na.rm = TRUE),
            `3着オッズ` = median(Odds3, na.rm = TRUE),
            `逆点数` = sum(jds)
            ) %>% 
  na.omit()

RunSummaryAllGood <- RunSummary %>% dplyr::filter(`馬場` == "良") %>%
  dplyr::group_by(RaceType) %>%
  summarise(`良` = length(`馬場`)) %>% na.omit()
RunSummaryAllYielding <- RunSummary %>% dplyr::filter(`馬場` == "稍") %>%
  dplyr::group_by(RaceType) %>%
  summarise(`稍重` = length(`馬場`)) %>% na.omit()
RunSummaryAllSoft <- RunSummary %>% dplyr::filter(`馬場` == "重") %>% 
  dplyr::group_by(RaceType) %>%
  summarise(`重` = length(`馬場`)) %>% na.omit()
RunSummaryAllHeavy <- RunSummary %>% dplyr::filter(`馬場` == "不") %>%
    dplyr::group_by(RaceType) %>%
    summarise(`不良` = length(`馬場`)) %>% na.omit()

suppressMessages(
  RunSummaryFieldCond <- full_join(RunSummaryAllGood, RunSummaryAllYielding, Key = "RaceType") %>% 
  full_join(RunSummaryAllSoft, Key = "RaceType") %>% 
  full_join(RunSummaryAllHeavy, Key = "RaceType")
)

RunSummaryFieldCond[,2:5] <- apply(RunSummaryFieldCond[2:5], 2, 
                             function(x){as.numeric(ifelse(is.na(x) == TRUE, 0, x))}) %>% 
  as.data.frame()

RunSummaryAll <- suppressMessages(
  inner_join(RunSummaryAll, RunSummaryFieldCond, Key = "RaceType")
)
RunSummaryAll$`良(%)` <- RunSummaryAll$`良` * 100 / 
  sum(RunSummaryAll$`良`, na.rm = TRUE)
RunSummaryAll$`稍重(%)` <- RunSummaryAll$`稍重` * 100 / 
  sum(RunSummaryAll$`稍重`, na.rm = TRUE)
RunSummaryAll$`重(%)` <- RunSummaryAll$`重` * 100 / 
  sum(RunSummaryAll$`重`, na.rm = TRUE)
RunSummaryAll$`不良(%)` <- RunSummaryAll$`不良` * 100/ 
  sum(RunSummaryAll$`不良`, na.rm = TRUE)
```


```{r, echo=FALSE, error=FALSE, warning=FALSE, fig.width= 6.00, fig.height= 4.00}
knitr::kable(RunSummaryAll[,1:9])
```

RaceType列は、それぞれどのような脚質の馬が1,2,3着に入線したかを示す。  
例えば、010は1着が逃げ馬、2着が差し馬、3着が逃げ馬であることを表す。

逃げ列、差し列は、その決着で決まったレースに出走していた逃げ馬、差し馬の数の平均を表す。  
例えば、000(すべて逃げ馬)で決まったときは、平均して逃げ馬のほうが差し馬より多かったことがわかる。  
馬券購入前に脚質を分類し、どのパターンの決着を狙うか検討するために計算している。

逆点数列は、1着のオッズが2着のオッズよりも高かったレースの数を表す。  
馬単、三連単の妙味は上位馬のオッズが高い時なので、この馬券を考察するために計算している。

なお、同着があった場合分析対象からはずしている。  

```{r, echo=FALSE, error=FALSE, warning=FALSE, fig.width= 6.00, fig.height= 4.00}
knitr::kable(RunSummaryAll[,c(1,10:17)])
```

次に馬場状態別でのそれぞれの入選順位を集計した。
